## Reference

[如何应对在线故障](https://github.com/superhj1987/pragmatic-java-engineer/blob/master/book/appendix/online-debug.md)

## Content

### 1、应对思路

第一时间上报给自己的直属领导或者相关负责人，由其把控后续流程，并在可能的情况下及时周知所有可能受影响方：问题、影响范围、解决方案、预计恢复时间等。

首先根据经验来分析。如果应急团队中有人对相应的问题有经验，并能确定能够通过某种手段恢复系统的正常运行，那么应该第一时间恢复（回滚等），同时务必要保留现场，以备后续对问题的定位和修复；如果没有人有经验，则需要使用比较粗暴的办法保证服务可用，如定时重启、限流、降级等。

之后就要业务负责人、技术负责人、核心研发人员、架构师、运维工程师以及运营人员对问题的原因进行快速分析，分析的过程需要首先考虑系统近期的变化，包括以下几方面：

> * 系统最近是否进行了发布上线工作？
> * 服务的使用方是否有运营活动？
> * 网络是否有流量的波动？
> * 最近的业务量是否上升？
> * 运营人员是否在系统了做了变动？
> * 依赖的基础平台和资源是否进行了发布上线？
> * 依赖的其他系统是否进行了发布上线？

### 2、可能原因

- **DNS、网络、CDN故障**
- **代码Bug**：逻辑不严谨、连接未释放
- **代码性能**：循环外部调用、未使用批量读取、正则循环等
- **内存泄漏**：本地缓存
- **异常流量/攻击**：DDOS
- **业务量提升**：容量预估失误
- **外部系统问题**:：数据库、搜索引擎、分布式缓存、消息队列等中间件的性能问题、应用的性能问题

### 3、分析步骤

- DNS 是否正常？可以通过 **ping** 命令来测试
- 网络是否正常？可以通过 **ping、telnet** 命令来测试
- 是否是 CDN 缓存的问题？如果使用了 CDN 缓存可能会出现内容不一致的问题
- 根据日志输出的异常信息定位问题，需要区分 Tomcat 中的 catalina.out（标准输出和错误）和 localhost.xx.log（应用初始化的日志，错误则无法启动）
- 磁盘是否已满(`df -h`)？磁盘满了则需要删除多余日志
- 流量是否有异常？通过限流、降级、扩展服务结点、架构优化等手段解决
- 外部系统问题则需要针对外部系统（数据库、搜索引擎、分布式缓存、消息队列）进行故障排查、性能优化等

**以上步骤未发现问题，就需要从应用的 CPU、内存、IO 方面做进一步分析。**

### 4、CPU分析

- 使用 top、vmstat、ps 等命令定位 CPU 使用率高的线程：`top -p [processId] -H`

- `jstack [pid]`打印繁忙进程的堆栈信息

- 通过`printf %0x [processId]`转换进程 id 为16进制，在堆栈信息中查找对应的堆栈信息

- `jstat -gcutil [pid]`，查看 GC 的情况是否正常，是否 GC 引起了 CPU 飚高

- JVM 加入 `-XX:+PrintCompilation` 参数，查看是否是JIT编译引起了 CPU 飚高

**CPU 繁忙可能的原因：**线程中有无限空循环、无阻塞、正则匹配或者单纯的计算；发生了频繁的 GC；多线程的上下文切换；JIT 编译

### 5、内存分析

- **堆外内存**：JNI、Deflater/Inflater、DirectByteBuffer。通过 vmstat、top、pidstat 等查看 swap 和物理内存的消耗状况。通过 Google-preftools 来追踪 JNI、Deflater 这种调用的资源使用状况

- **堆内存**：

  > * 查看 JVM 内存使用状况：`jmap -heap <pid>`
  > * 查看 JVM 内存存活的对象：`jmap -histo:live <pid>`
  > * 把 heap 里所有对象都 dump 下来，无论对象是死是活：`jmap -dump:format=b,file=xxx.hprof <pid>`
  > * 先做一次Full GC，再dump，只包含仍然存活的对象信息：`jmap -dump:format=b,live,file=xxx.hprof <pid>`
  > * 使用 **Eclipse MAT** 或者 **jhat** 打开堆 dump 的文件，根据内存中的具体对象使用情况分析
  > * VJTools 中的 **vjmap** 可以分代打印出堆内存的对象实例占用信息

  堆内存中包括创建的对象、全局集合、缓存、ClassLoader、多线程等，都有可能造成问题。

### 6、磁盘IO分析

- 

### 7、网络IO分析

### 8、在线代码分析

### 9、故障解决

### 10、CPU使用优化

### 11、内存使用优化

### 12、IO使用优化

### 13、JVM配置

### 14、代码性能建议